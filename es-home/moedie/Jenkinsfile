@Library('es-jenkins-shared') _
def registry = 'artifacts.trmc.osd.mil/minerva-docker'
def base = 'extension-scaffold/es-home'
def trmc_image_version = params.TRMC_IMAGE_VERSION ? params.TRMC_IMAGE_VERSION : ""

pipeline {
    agent any
    environment {
        VERSION_FROM_GIT_TAG = sh(script: "git describe --tags --exact-match --match 'es-*' | sed -e s/es-//", returnStdout: true).trim()
    }
    options {
        buildDiscarder logRotator(artifactDaysToKeepStr: '', artifactNumToKeepStr: '', daysToKeepStr: '7', numToKeepStr: '5')
    }
    parameters {
        string(name: 'TRMC_IMAGE_VERSION', description: 'If set, tag and push into TRMC', trim: true)
    }
    stages {
        // Checking Release
        /*
        stage('Check release') {
            when {
                branch "release*"
            }
            steps {
                script {
                if (!env.VERSION_FROM_GIT_TAG) {
                    error('Branch `release` does not refer to a tag')
                }
                trmc_image_version = env.VERSION_FROM_GIT_TAG
                echo "Setting TRMC_IMAGE_VERSION to ${VERSION_FROM_GIT_TAG}"
                }
            }
        }
        */
        // Building the container
        stage('Build es-home container') {
            steps {
                script {
                    sh '''
                    docker build -t es-home ./es-home
                    '''
                }
            }
        }
        // Pushing to TRMC?
        stage('shared-library testEcho'){
            steps {
                testEcho()
            }
        }
    }
}